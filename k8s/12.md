# ConfigMaps

1. I created folder **files** inside my chart
2. I added to this folder file **config.json** 
```json
    {
      "app_name": "app-python",
      "version": "1.0.0",
      "debug": true
    }
```
3. I added **configmap.yaml** to my chart
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: python-config
data:
  config.json: |-
{{ .Files.Get "files/config.json" | indent 4 }}
```
4. I updated deployment
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Chart.Name }}
  labels:
    {{- include "common.labels" . | nindent 4 }}
    app-python/special-label: "app-python"
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ .Chart.Name }}
  template:
    metadata:
      labels:
        {{- include "common.labels" . | nindent 8 }}
    spec:
      serviceAccountName: vault-auth
      volumes:
        - name: config-volume
          configMap:
            name: python-config
      containers:
        - name: {{ .Chart.Name }}
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          volumeMounts:
            - name: config-volume
              mountPath: /config.json
              subPath: config.json
          resources:
            requests:
              cpu: {{ .Values.resources.requests.cpu }}
              memory: {{ .Values.resources.requests.memory }}
            limits:
              cpu: {{ .Values.resources.limits.cpu }}
              memory: {{ .Values.resources.limits.memory }}
          ports:
            - name: http
              containerPort: {{ .Values.service.port }}
              protocol: TCP
          env:
            - name: MY_USER
              valueFrom:
                secretKeyRef:
                  name: my-secret
                  key: MY_USER
            - name: MY_PASS
              valueFrom:
                secretKeyRef:
                  name: my-secret
                  key: MY_PASS
          {{- include "app-python.environmentVars" . | nindent 10 }}
```
5. Proof that configmaps works
```bash
  kubectl get po
```
```
  NAME                         READY   STATUS    RESTARTS      AGE
  app-go-864df4cbf9-7kmr2      1/1     Running   2 (29m ago)   7d14h
  app-python-95f4d4954-wm22p   1/1     Running   0             48s
```

```bash
  kubectl exec app-python-95f4d4954-wm22p -- cat /config.json
```
```json
{
  "app_name": "app-python",
  "version": "1.0.0",
  "debug": true
}
```

# Bonus
I decided to do envFrom scenario on my bonus application to not rewrite previous

1. I created file **configmap.yaml** in my go chart
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: go-config
data:
  APP_MODE: "production"
  GITHUB_REPO_URL: "https://api.github.com/repos/inno-devops-labs/S25-core-course-labs/forks?per_page=100"
```

2. I updated my deployment
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Chart.Name }}
  labels:
    {{- include "common.labels" . | nindent 4 }}
    app-go/special-label: "app-go"
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ .Chart.Name }}
  template:
    metadata:
      labels:
        {{- include "common.labels" . | nindent 8 }}
    spec:
      containers:
        - name: {{ .Chart.Name }}
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          envFrom:
            - configMapRef:
                name: go-config
          resources:
            requests:
              cpu: {{ .Values.resources.requests.cpu }}
              memory: {{ .Values.resources.requests.memory }}
            limits:
              cpu: {{ .Values.resources.limits.cpu }}
              memory: {{ .Values.resources.limits.memory }}
          ports:
            - name: http
              containerPort: {{ .Values.service.port }}
              protocol: TCP
          env:
            {{- include "app-go.environmentVars" . | nindent 10 }}
```

3. Proof that env works
```bash
  kubectl get po
```
```
NAME                         READY   STATUS    RESTARTS   AGE
app-go-78795d94bb-t7lpw      1/1     Running   0          32s
app-python-95f4d4954-wm22p   1/1     Running   0          29m
```

```bash
  kubectl exec -it app-go-78795d94bb-t7lpw -- env
```
```
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
HOSTNAME=app-go-78795d94bb-t7lpw
TERM=xterm
APP_MODE=production
GITHUB_REPO_URL=https://api.github.com/repos/inno-devops-labs/S25-core-course-labs/forks?per_page=100
AUTHOR=secretanry
COURSE=Devops
APP_GO_PORT_8080_TCP_PROTO=tcp
APP_GO_PORT_8080_TCP_PORT=8080
APP_GO_PORT_8080_TCP_ADDR=10.97.200.28
APP_PYTHON_SERVICE_HOST=10.100.205.200
APP_PYTHON_SERVICE_PORT=8000
KUBERNETES_SERVICE_HOST=10.96.0.1
KUBERNETES_PORT=tcp://10.96.0.1:443
KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443
APP_PYTHON_PORT_8000_TCP_ADDR=10.100.205.200
APP_GO_SERVICE_PORT=8080
APP_GO_SERVICE_PORT_HTTP=8080
APP_PYTHON_SERVICE_PORT_HTTP=8000
APP_PYTHON_PORT_8000_TCP=tcp://10.100.205.200:8000
APP_PYTHON_PORT_8000_TCP_PROTO=tcp
KUBERNETES_SERVICE_PORT_HTTPS=443
KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1
APP_GO_SERVICE_HOST=10.97.200.28
APP_GO_PORT_8080_TCP=tcp://10.97.200.28:8080
KUBERNETES_SERVICE_PORT=443
KUBERNETES_PORT_443_TCP_PROTO=tcp
KUBERNETES_PORT_443_TCP_PORT=443
APP_GO_PORT=tcp://10.97.200.28:8080
APP_PYTHON_PORT=tcp://10.100.205.200:8000
APP_PYTHON_PORT_8000_TCP_PORT=8000
HOME=/home/executor
```
